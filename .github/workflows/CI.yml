name: Fuwari-yCENzh CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    repository_dispatch:
        types: [content-updated]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    check:
        name: Astro Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Checkout content repo
              uses: actions/checkout@v6
              with:
                  repository: wangxvvv/Blog
                  path: content

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Sync content mappings
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_DIR: content
              run: node scripts/sync-content.js

            - name: Run Astro Check
              run: pnpm astro check
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_DIR: content

            - name: Run Astro Build
              run: pnpm astro build
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_DIR: content
    deploy:
        name: Deploy to Ubuntu (self-hosted)
        needs: check
        runs-on: self-hosted

        # 只允许 main 的 push、dispatch、手动触发 才部署（PR 不部署）
        if: |
            github.event_name == 'push' ||
            github.event_name == 'repository_dispatch' ||
            github.event_name == 'workflow_dispatch'

        steps:
            - name: Checkout code (always main)
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build (sync content + build)
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_REPO_URL: ${{ secrets.CONTENT_REPO_URL }}
              run: pnpm build

            - name: Publish to nginx (atomic)
              run: |
                  set -e
                  TS=$(date +%Y%m%d_%H%M%S)
                  RELEASE_DIR=/srv/mizuki/releases/$TS
                  mkdir -p "$RELEASE_DIR"
                  rsync -a --delete dist/ "$RELEASE_DIR/"
                  ln -sfn "$RELEASE_DIR" /srv/mizuki/current
                  ls -1dt /srv/mizuki/releases/* | tail -n +11 | xargs -r rm -rf
                  echo "Deployed $TS"
