name: Fuwari-yCENzh CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    repository_dispatch:
        types: [content-updated]
    workflow_dispatch:

concurrency:
    group: mizuki-ci-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    check:
        name: CI · Astro Check & Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Checkout content repo
              uses: actions/checkout@v4
              with:
                  repository: wangxvvv/Blog
                  token: ${{ secrets.CONTENT_REPO_TOKEN }}
                  ref: main
                  path: content

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Sync content mappings
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_DIR: content
              run: node scripts/sync-content.js

            - name: Astro Check
              run: pnpm astro check

            - name: Astro Build
              run: pnpm astro build

    deploy:
        name: Deploy · Ubuntu (self-hosted)
        needs: check
        runs-on: self-hosted

        if: |
            github.event_name == 'push' ||
            github.event_name == 'repository_dispatch' ||
            github.event_name == 'workflow_dispatch'

        steps:
            - name: Checkout code (main)
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Checkout content repo
              uses: actions/checkout@v4
              with:
                  repository: wangxvvv/Blog
                  token: ${{ secrets.CONTENT_REPO_TOKEN }}
                  ref: main
                  path: content

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Sync content mappings
              env:
                  ENABLE_CONTENT_SYNC: "true"
                  CONTENT_DIR: content
              run: node scripts/sync-content.js

            - name: Build (production)
              run: pnpm build

            - name: Publish to nginx (atomic)
              run: |
                  set -e
                  TS=$(date +%Y%m%d_%H%M%S)
                  RELEASE_DIR=/srv/mizuki/releases/$TS
                  mkdir -p "$RELEASE_DIR"
                  rsync -a --delete dist/ "$RELEASE_DIR/"
                  ln -sfn "$RELEASE_DIR" /srv/mizuki/current
                  ls -1dt /srv/mizuki/releases/* | tail -n +11 | xargs -r rm -rf
                  echo "Deployed $TS"
