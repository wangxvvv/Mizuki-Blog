---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { LinkPreset, type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	link: NavBarLink;
	class?: string;
}

const { link, class: className } = Astro.props;

const navTitleMap: Record<string, I18nKey> = {
	Links: I18nKey.navLinks,
	My: I18nKey.navMy,
	About: I18nKey.navAbout,
	about: I18nKey.about,
	Others: I18nKey.navOthers,
	Anime: I18nKey.anime,
	Diary: I18nKey.diary,
	Gallery: I18nKey.albums,
	Devices: I18nKey.devices,
	Projects: I18nKey.projects,
	Skills: I18nKey.skills,
	Timeline: I18nKey.timeline,
	Friends: I18nKey.friends,
};

const getLocalizedName = (name: string): string => {
	return name in navTitleMap ? i18n(navTitleMap[name]) : name;
};

const processedLink = {
	...link,
	children: link.children?.map(
		(child: NavBarLink | LinkPreset): NavBarLink =>
			typeof child === "number" ? LinkPresets[child] : child,
	),
};

const hasChildren = processedLink.children && processedLink.children.length > 0;
---

<div class:list={["dropdown-container", className]} data-dropdown>
	{
		hasChildren ? (
			<>
				<button
					class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 dropdown-trigger"
					aria-expanded="false"
					aria-haspopup="true"
					data-dropdown-trigger
				>
					<div class="flex items-center">
						{processedLink.icon && (
							<Icon
								name={processedLink.icon}
								class="text-[1.1rem] mr-2"
							/>
						)}
						{getLocalizedName(processedLink.name)}
						<Icon
							name="material-symbols:keyboard-arrow-down-rounded"
							class="text-[1.25rem] transition-transform duration-200 dropdown-arrow ml-1"
						/>
					</div>
				</button>
				<div class="dropdown-menu" data-dropdown-menu>
					<div class="dropdown-content">
						{processedLink.children?.map((child) => (
							<a
								href={child.external ? child.url : url(child.url)}
								target={child.external ? "_blank" : null}
								rel={child.external ? "noopener noreferrer" : null}
								class="dropdown-item"
								aria-label={child.name}
							>
								<div class="flex items-center">
									{child.icon && (
										<Icon
											name={child.icon}
											class="text-[1rem] mr-2"
										/>
									)}
									<span>{getLocalizedName(child.name)}</span>
								</div>
								{child.external && (
									<Icon
										name="fa6-solid:arrow-up-right-from-square"
										class="text-[0.75rem] text-black/25 dark:text-white/25"
									/>
								)}
							</a>
						))}
					</div>
				</div>
			</>
		) : (
			<a
				aria-label={processedLink.name}
				href={
					processedLink.external
						? processedLink.url
						: url(processedLink.url)
				}
				target={processedLink.external ? "_blank" : null}
				rel={processedLink.external ? "noopener noreferrer" : null}
				class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95"
			>
				<div class="flex items-center">
					{processedLink.icon && (
						<Icon
							name={processedLink.icon}
							class="text-[1.1rem] mr-2"
						/>
					)}
					{getLocalizedName(processedLink.name)}
					{processedLink.external && (
						<Icon
							name="fa6-solid:arrow-up-right-from-square"
							class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]"
						/>
					)}
				</div>
			</a>
		)
	}
</div>

<style>
	.dropdown-container {
		@apply relative;
	}

	.dropdown-menu {
		@apply absolute top-full left-0 pt-2 opacity-0 pointer-events-none transform translate-y-[-10px] scale-[0.985] z-50;
		visibility: hidden;
		transition:
			opacity 180ms ease-out,
			transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
			filter 220ms ease-out,
			visibility 0s linear 220ms;
		filter: blur(6px);
		transform-origin: top center;
		will-change: opacity, transform, filter;
	}

	.dropdown-container[data-open="true"] .dropdown-menu {
		@apply opacity-100 visible pointer-events-auto translate-y-0;
		visibility: visible;
		transition-delay: 0s, 0s, 0s, 0s;
		transform: translateY(0) scale(1);
		filter: blur(0);
	}

	.dropdown-container[data-open="true"] .dropdown-arrow {
		@apply rotate-180;
	}

	.dropdown-content {
		@apply bg-[var(--float-panel-bg)] rounded-[var(--radius-large)] shadow-xl dark:shadow-none border border-black/5 dark:border-white/10 py-2 min-w-[12rem];
	}

	.dropdown-item {
		@apply flex items-center justify-between px-4 py-2.5 text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition-colors duration-150 font-medium;
	}

	.dropdown-item:first-child {
		@apply rounded-t-[calc(var(--radius-large)-0.5rem)];
	}

	.dropdown-item:last-child {
		@apply rounded-b-[calc(var(--radius-large)-0.5rem)];
	}

	@media (max-width: 768px) {
		.dropdown-container {
			@apply hidden;
		}
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const dropdowns = document.querySelectorAll("[data-dropdown]");

		dropdowns.forEach((dropdown) => {
			const trigger = dropdown.querySelector(
				"[data-dropdown-trigger]",
			) as HTMLElement;
			const menu = dropdown.querySelector(
				"[data-dropdown-menu]",
			) as HTMLElement;
			const items = dropdown.querySelectorAll(
				".dropdown-item",
			) as NodeListOf<HTMLElement>;

			if (!trigger || !menu) return;

			let hideTimer: number | null = null;
			let lastOpenMode: "hover" | "click" = "hover";
			let openByClick = false;

			function clearHideTimer() {
				if (hideTimer) {
					clearTimeout(hideTimer);
					hideTimer = null;
				}
			}

			function closeDropdown() {
				clearHideTimer();
				openByClick = false;
				trigger.setAttribute("aria-expanded", "false");
				dropdown.setAttribute("data-open", "false");
				menu.classList.add(
					"opacity-0",
					"invisible",
					"pointer-events-none",
					"translate-y-[-8px]",
				);
				menu.classList.remove(
					"opacity-100",
					"visible",
					"pointer-events-auto",
					"translate-y-0",
				);
			}

			function openDropdown(mode: "hover" | "click") {
				lastOpenMode = mode;
				openByClick = mode === "click";
				clearHideTimer();
				trigger.setAttribute("aria-expanded", "true");
				dropdown.setAttribute("data-open", "true");
				menu.classList.remove(
					"opacity-0",
					"invisible",
					"pointer-events-none",
					"translate-y-[-8px]",
				);
				menu.classList.add(
					"opacity-100",
					"visible",
					"pointer-events-auto",
					"translate-y-0",
				);
			}

			function openDropdownByClick() {
				if (trigger.getAttribute("aria-expanded") !== "true") {
					openDropdown("click");
				} else {
					lastOpenMode = "click";
					openByClick = true;
				}
			}

			function scheduleClose() {
				clearHideTimer();
				const delay = lastOpenMode === "click" ? 260 : 120;
				hideTimer = window.setTimeout(() => closeDropdown(), delay);
			}

			trigger.addEventListener("keydown", function (e) {
				if (e.key === "Enter" || e.key === " ") {
					e.preventDefault();
					openDropdownByClick();
				} else if (e.key === "ArrowDown") {
					e.preventDefault();
					openDropdown("click");
					if (items.length > 0) {
						items[0].focus();
					}
				} else if (e.key === "Escape") {
					closeDropdown();
				}
			});

			trigger.addEventListener("click", function (e) {
				e.preventDefault();
				openDropdownByClick();
			});

			let isTriggerHover = false;
			let isMenuHover = false;

			function scheduleCloseIfOutside() {
				if (
					(openByClick && !isMenuHover) ||
					(!openByClick && !isTriggerHover && !isMenuHover)
				) {
					scheduleClose();
				}
			}

			trigger.addEventListener("mouseenter", () => {
				isTriggerHover = true;
				if (!openByClick) {
					openDropdown("hover");
				}
			});
			trigger.addEventListener("mouseleave", () => {
				isTriggerHover = false;
				scheduleCloseIfOutside();
			});
			menu.addEventListener("mouseenter", () => {
				isMenuHover = true;
				clearHideTimer();
			});
			menu.addEventListener("mouseleave", () => {
				isMenuHover = false;
				scheduleCloseIfOutside();
			});

			items.forEach((item, index) => {
				item.addEventListener("keydown", function (e) {
					if (e.key === "ArrowDown") {
						e.preventDefault();
						const nextIndex = (index + 1) % items.length;
						items[nextIndex].focus();
					} else if (e.key === "ArrowUp") {
						e.preventDefault();
						const prevIndex =
							(index - 1 + items.length) % items.length;
						items[prevIndex].focus();
					} else if (e.key === "Escape") {
						closeDropdown();
						trigger.focus();
					}
				});
			});
		});

		document.addEventListener("click", function (e) {
			const dropdowns = document.querySelectorAll("[data-dropdown]");
			dropdowns.forEach((dropdown) => {
				if (!dropdown.contains(e.target as Node)) {
					const trigger = dropdown.querySelector(
						"[data-dropdown-trigger]",
					) as HTMLElement;
					const menu = dropdown.querySelector(
						"[data-dropdown-menu]",
					) as HTMLElement;
					if (trigger && menu) {
						trigger.setAttribute("aria-expanded", "false");
						dropdown.setAttribute("data-open", "false");
						menu.classList.add(
							"opacity-0",
							"invisible",
							"pointer-events-none",
							"translate-y-[-8px]",
						);
						menu.classList.remove(
							"opacity-100",
							"visible",
							"pointer-events-auto",
							"translate-y-0",
						);
					}
				}
			});
		});
	});
</script>
